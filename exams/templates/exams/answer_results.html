{% extends 'accounts/base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">回答結果</h2>
    
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">正解率</h5>
            <p class="card-text">
                正解数: {{ correct_count }} / {{ total_count }} ({{ correct_count|divide:total_count|multiply:100|floatformat:1 }}%)
            </p>
        </div>
    </div>
    
    {% if question_type == 'listening_illustration' %}
        {% for answer in answers_with_questions %}
    <div class="card mb-4">
        <div class="card-body">
                <h5 class="card-title">問題 {{ forloop.counter }}</h5>
                
                {% if answer.question.image %}
                <div class="text-center mb-3">
                    <img src="{% static answer.question.image %}" alt="問題のイラスト" class="img-fluid" style="max-width: 300px; height: auto;">
                </div>
                {% endif %}
                
                {% if answer.question.audio %}
                <div class="text-center mb-3">
                    <audio controls class="w-100" style="max-width: 400px;">
                        <source src="{% static answer.question.audio %}" type="audio/mpeg">
                        お使いのブラウザは音声再生に対応していません。
                    </audio>
                </div>
                {% endif %}
                
                <div class="choices mb-3">
                    <h6>選択肢:</h6>
                    {% for choice in answer.choices %}
                    <div class="form-check">
                        <input class="form-check-input" type="radio" disabled 
                               {% if answer.user_answer == choice.choice_text %}checked{% endif %}>
                        <label class="form-check-label">
                            {{ choice.choice_text }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-3">
                    <p class="{% if answer.is_correct %}text-success{% else %}text-danger{% endif %}">
                        {% if answer.is_correct %}
                        <strong>正解です！</strong>
                        {% else %}
                        <strong>不正解です。</strong>
                        {% endif %}
                    </p>
                    <p><strong>あなたの回答:</strong> {{ answer.user_answer }}</p>
                    <p><strong>正解:</strong> {{ answer.correct_answer }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    {% elif question_type == 'reading_comprehension' %}
        {% for passage, answers in passages_with_answers.items %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">本文 {{ forloop.counter }}</h5>
            </div>
            <div class="card-body">
                <p class="card-text">{{ passage.content|linebreaks }}</p>
                
                {% for answer in answers %}
                <div class="mt-4">
                    <h6>問題 {{ forloop.counter }}</h6>
                    <p>{{ answer.question.question_text|linebreaks }}</p>
                    
                <div class="mt-3">
                        <p class="{% if answer.is_correct %}text-success{% else %}text-danger{% endif %}">
                            {% if answer.is_correct %}
                            正解です！
                            {% else %}
                            不正解です。
                            {% endif %}
                        </p>
                        <p>あなたの回答: {{ answer.user_answer.choice_text }}</p>
                        <p>正解: {{ answer.correct_choice.choice_text }}</p>
                        {% if answer.explanation %}
                        <div class="alert alert-info">
                            <strong>解説:</strong><br>
                            {{ answer.explanation|linebreaks }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        {% for answer in answers_with_questions %}
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">問題 {{ forloop.counter }}</h5>
                <p class="card-text">{{ answer.question.question_text|linebreaks }}</p>
                
                <div class="mt-3">
                    <p class="{% if answer.is_correct %}text-success{% else %}text-danger{% endif %}">
                        {% if answer.is_correct %}
                        正解です！
                        {% else %}
                        不正解です。
                        {% endif %}
                    </p>
                    <p>あなたの回答: {{ answer.user_answer.choice_text }}</p>
                    <p>正解: {{ answer.correct_choice.choice_text }}</p>
                    {% if answer.explanation %}
                    <div class="alert alert-info">
                        <strong>解説:</strong><br>
                        {{ answer.explanation|linebreaks }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% endif %}
    
    <div class="text-center mt-4">
        <a href="{% url 'exams:question_list_by_level' level=level %}?type={{ question_type }}" class="btn btn-primary">問題一覧に戻る</a>
    </div>
</div>
{% endblock %} 