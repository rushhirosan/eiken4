{% extends 'accounts/base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">回答結果</h2>
    
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">正解率</h5>
            <p class="card-text">
                正解数: {{ correct_count }} / {{ total_count }} ({{ correct_count|divide:total_count|multiply:100|floatformat:1 }}%)
            </p>
        </div>
    </div>
    
    {% if question_type == 'listening_illustration' %}
        {% for answer in answers_with_questions %}
    <div class="card mb-4">
        <div class="card-body">
                <h5 class="card-title">問題 {{ forloop.counter }}</h5>
                
                {% if answer.question.image %}
                <div class="text-center mb-3">
                    <img src="{% static answer.question.image %}" alt="問題のイラスト" class="img-fluid" style="max-width: 100%; height: auto;">
                </div>
                {% endif %}
                
                {% if answer.question.audio %}
                <div class="text-center mb-3">
                    <audio controls class="w-100" style="max-width: 100%;">
                        <source src="{% static answer.question.audio %}" type="audio/mpeg">
                        お使いのブラウザは音声再生に対応していません。
                    </audio>
                </div>
                {% endif %}
                
                <div class="choices mb-3">
                    <h6>選択肢:</h6>
                    {% for choice in answer.choices %}
                    <div class="form-check">
                        <input class="form-check-input" type="radio" disabled 
                               {% if answer.user_answer == choice.choice_text %}checked{% endif %}>
                        <label class="form-check-label">
                            {{ choice.choice_text }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-3">
                    <p class="{% if answer.is_correct %}text-success{% else %}text-danger{% endif %}">
                        {% if answer.is_correct %}
                        <strong>正解です！</strong>
                        {% else %}
                        <strong>不正解です。</strong>
                        {% endif %}
                    </p>
                    <p><strong>あなたの回答:</strong> 
                        {% if answer.correct_choice %}
                            選択肢{% for choice in answer.choices %}{% if choice.choice_text == answer.user_answer %}{{ choice.order }}{% endif %}{% endfor %}
                        {% else %}
                            {{ answer.user_answer }}
                        {% endif %}
                    </p>
                    <p><strong>正解:</strong> 
                        {% if answer.correct_choice %}
                            選択肢{{ answer.correct_choice.order }}
                        {% else %}
                            {{ answer.correct_answer }}
                        {% endif %}
                    </p>
                    {% if answer.explanation %}
                    <div class="alert alert-info mt-2">
                        <strong>解説:</strong><br>
                        {{ answer.explanation|linebreaks }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% elif question_type == 'reading_comprehension' %}
        {% for passage, answers in passages_with_answers.items %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">本文 {{ forloop.counter }}</h5>
            </div>
            <div class="card-body">
                <p class="card-text">{{ passage.text|linebreaks }}</p>
                
                {% for answer in answers %}
                <div class="mt-4">
                    <h6>問題 {{ forloop.counter }}</h6>
                    <p>{{ answer.question.question_text|linebreaks }}</p>
                    
                <div class="mt-3">
                        <p class="{% if answer.is_correct %}text-success{% else %}text-danger{% endif %}">
                            {% if answer.is_correct %}
                            正解です！
                            {% else %}
                            不正解です。
                            {% endif %}
                        </p>
                        <p>あなたの回答: {{ answer.user_answer.choice_text }}</p>
                        <p>正解: {{ answer.correct_choice.choice_text }}</p>
                        {% if answer.explanation %}
                        <div class="alert alert-info">
                            <strong>解説:</strong><br>
                            {{ answer.explanation|linebreaks }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        {% for answer in answers_with_questions %}
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">問題 {{ forloop.counter }}</h5>
                <p class="card-text">{{ answer.question.question_text|linebreaks }}</p>
                
                <div class="mt-3">
                    <p class="{% if answer.is_correct %}text-success{% else %}text-danger{% endif %}">
                        {% if answer.is_correct %}
                        正解です！
                        {% else %}
                        不正解です。
                        {% endif %}
                    </p>
                    <p>あなたの回答: {{ answer.user_answer.choice_text }}</p>
                    <p>正解: {% if answer.correct_choice %}{{ answer.correct_choice.choice_text }}{% else %}（正解が見つかりませんでした）{% endif %}</p>
                    {% if answer.explanation %}
                    <div class="alert alert-info">
                        <strong>解説:</strong><br>
                        {{ answer.explanation|linebreaks }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% endif %}
    
    <div class="text-center mt-5 mb-5">
        <a href="{% url 'exams:exam_list' %}" class="btn btn-primary">問題一覧に戻る</a>
    </div>
</div>

<style>
/* モバイル最適化 */
@media (max-width: 768px) {
    h2 {
        font-size: 1.5rem;
    }
    
    h5, h6 {
        font-size: 1.1rem;
    }
    
    .card {
        margin-bottom: 1rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .card-header {
        padding: 0.75rem 1rem;
    }
    
    .btn {
        min-height: 44px;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
    }
    
    .form-check {
        padding: 0.75rem 0;
        margin-bottom: 0.5rem;
    }
    
    .form-check-input {
        width: 1.25rem;
        height: 1.25rem;
    }
    
    .alert {
        font-size: 0.95rem;
    }
    
    audio {
        width: 100% !important;
    }
}

@media (max-width: 576px) {
    h2 {
        font-size: 1.3rem;
    }
    
    .card-body {
        padding: 0.75rem;
    }
    
    .btn {
        font-size: 0.9rem;
        padding: 0.7rem 1.2rem;
    }
}
</style>
{% endblock %} 